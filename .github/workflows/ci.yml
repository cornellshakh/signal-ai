name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  lint-and-format:
    name: "Test: Lint & Format"
    runs-on: ubuntu-latest

    steps:
      - name: "⬇️ Check out code"
        uses: actions/checkout@v3

      - name: "🐍 Set up Python 3.13"
        uses: actions/setup-python@v3
        with:
          python-version: "3.13"

      - name: "💾 Cache dependencies"
        uses: actions/cache@v3
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-

      - name: "📦 Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install

      - name: "🔬 Lint with ruff"
        run: poetry run ruff check .

      - name: "💅 Format with ruff"
        run: poetry run ruff format --check .

  build-docker:
    name: "Build: Docker Image"
    runs-on: ubuntu-latest
    needs: lint-and-format

    steps:
      - name: "⬇️ Check out code"
        uses: actions/checkout@v3

      - name: "🐳 Build Docker image"
        run: docker build . --file Dockerfile
